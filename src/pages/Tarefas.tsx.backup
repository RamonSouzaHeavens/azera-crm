import { useNavigate } from 'react-router-dom'
import { Plus, Grid3X3, Kanban, Search, X, AlarmClock, CalendarDays, Users, Tag, ListChecks, Check, Timer, Trash2, FileText, ChevronDown, ChevronUp, Filter, Settings, Edit } from 'lucide-react'
import { DragDropContext, Droppable, Draggable, type DropResult } from '@hello-pangea/dnd'
import toast from 'react-hot-toast'
import { supabase } from '../lib/supabase'
import { useAuthStore } from '../stores/authStore'
import { addResponsavel } from '../services/responsavelService'
import { TaskAttachments } from '../components/team/TaskAttachments'
import { loadTaskStages, createTaskStage, updateTaskStage, deleteTaskStage } from '../services/taskPipelineService'
import { useState, useMemo, useCallback, useEffect } from 'react'

// =====================
// Tipos
// =====================
export type TaskStatus = string
export type TaskPriority = 'baixa' | 'media' | 'alta' | 'urgente'

interface ClienteRef { id: string; nome: string }
interface ProdutoRef { id: string; nome: string }
interface UsuarioRef { id: string; display_name: string | null }
interface EquipeRef { id: string; nome: string }

interface ChecklistItem {
  id: string
  texto: string
  done: boolean
}

interface Tarefa {
  id: string
  tenant_id: string
  titulo: string
  descricao: string | null
  status: TaskStatus
  prioridade: TaskPriority
  cliente_id: string | null
  produto_id: string | null
  responsavel_id: string | null
  equipe_id: string | null
  data_vencimento: string | null // ISO
  created_at: string
  updated_at: string
  process_id: string | null // Adicionando o relacionamento com processos
  
  // Campos adicionais que estavam sendo usados mas n√£o definidos
  tempo_gasto_minutos?: number | null
  estimativa_minutos?: number | null
  checklist?: ChecklistItem[] | null
  
  // Relacionamentos
  cliente?: ClienteRef | null | undefined
  produto?: ProdutoRef | null | undefined
  responsavel?: UsuarioRef | null | undefined
  responsavel_nome?: string | null
  equipe?: EquipeRef | null | undefined
  processo?: { id: string; title: string } | null // Adicionando relacionamento com processo
}

interface Filtros {
  q?: string
  status?: TaskStatus | 'todos'
  prioridade?: TaskPriority | 'todas'
  clienteId?: string | 'todos'
  produtoId?: string | 'todos'
  responsavelId?: string | 'todos'
  equipeId?: string | 'todas'
  dueFrom?: string
  dueTo?: string
}

// =====================
// Paleta / UI Maps
// =====================
const STATUS_MAP: Record<TaskStatus, { label: string; bg: string; text: string; ring: string; dot: string }>= {
  pendente:      { label: 'Pendente',     bg: 'bg-white/10',      text: 'text-slate-900 dark:text-slate-200',  ring: 'ring-indigo-500/30', dot: 'bg-indigo-400'  },
  em_andamento: { label: 'Em Progresso', bg: 'bg-cyan-500/10',   text: 'text-cyan-700 dark:text-cyan-200',   ring: 'ring-cyan-500/30',   dot: 'bg-cyan-400'   },
  bloqueada:    { label: 'Bloqueada',    bg: 'bg-rose-500/10',   text: 'text-rose-700 dark:text-rose-200',   ring: 'ring-rose-500/30',   dot: 'bg-rose-400'   },
  concluida:    { label: 'Conclu√≠da',    bg: 'bg-emerald-500/10',text: 'text-emerald-700 dark:text-emerald-200',ring: 'ring-emerald-500/30', dot: 'bg-emerald-400' },
}

const PRIORITY_MAP: Record<TaskPriority, { label: string; pill: string }>= {
  baixa:   { label: 'Baixa',   pill: 'bg-white/10 text-slate-900 dark:text-slate-300' },
  media:   { label: 'M√©dia',   pill: 'bg-indigo-500/10 text-indigo-700 dark:text-indigo-200' },
  alta:    { label: 'Alta',    pill: 'bg-amber-500/10 text-amber-700 dark:text-amber-200' },
  urgente: { label: 'Urgente', pill: 'bg-rose-600/10 text-rose-700 dark:text-rose-200' },
}

// const brl helper removed (n√£o utilizado)

// =====================
// P√°gina
// =====================
export default function Tarefas() {
  const navigate = useNavigate()
  const { tenant, member } = useAuthStore()
  const tenantId = useMemo(() => tenant?.id ?? member?.tenant_id ?? '', [tenant?.id, member?.tenant_id])

  const [loading, setLoading] = useState(true)
  const [tarefas, setTarefas] = useState<Tarefa[]>([])

  const [view, setView] = useState<'grid'|'kanban'>('kanban')
  const [filtros, setFiltros] = useState<Filtros>({ status: 'todos', prioridade: 'todas', clienteId: 'todos', produtoId: 'todos', responsavelId: 'todos', equipeId: 'todas' })
  const [filtersOpen, setFiltersOpen] = useState(false)

  // refs para selects
  const [clientes, setClientes] = useState<ClienteRef[]>([])
  const [produtos, setProdutos] = useState<ProdutoRef[]>([])
  const [usuarios, setUsuarios] = useState<UsuarioRef[]>([])
  const [equipes, setEquipes] = useState<Array<{ id: string; nome: string }>>([])
  const [responsaveisCustomizados, setResponsaveisCustomizados] = useState<string[]>([])

  // Drawer & Modal
  const [openTaskId, setOpenTaskId] = useState<string | null>(null)

  const [detalhe, setDetalhe] = useState<Tarefa | null>(null)
  const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false)
  const [showChecklist, setShowChecklist] = useState(true)
  const [showCustomResponsavel, setShowCustomResponsavel] = useState(false)

  // Task Stages
  const [taskStages, setTaskStages] = useState<Array<{id?: string; key: string, label: string, color: string}>>([])
  const [showTaskStagesSettings, setShowTaskStagesSettings] = useState(false)
  const [editingStageIndex, setEditingStageIndex] = useState<number | null>(null)
  const [editingStageName, setEditingStageName] = useState('')
  const [newStageName, setNewStageName] = useState('')
  const [newStageColor, setNewStageColor] = useState('#6366F1')
  const [stageToDelete, setStageToDelete] = useState<{index: number; label: string} | null>(null)

  // =====================
  // Helpers
  // =====================
  // Fun√ß√£o para converter checklist de string para array se necess√°rio
  const parseChecklist = (data: unknown) => {
    if (typeof data === 'string') {
      try {
        return JSON.parse(data);
      } catch {
        return [];
      }
    }
    return Array.isArray(data) ? data : [];
  }

  // =====================
  // Carregamentos
  // =====================
  const loadClientes = useCallback(async () => {
    if (!tenantId) return
    const { data, error } = await supabase
      .from('clientes')
      .select('id, nome')
      .eq('tenant_id', tenantId)
      .order('nome')
    if (error) { console.warn('Clientes erro:', error.message); setClientes([]); return }
    setClientes(data ?? [])
  }, [tenantId])

  const loadProdutos = useCallback(async () => {
    if (!tenantId) return
    // opcional: se a tabela produtos n√£o existir, ignora silenciosamente
    const { data, error } = await supabase
      .from('produtos')
      .select('id, nome')
      .eq('tenant_id', tenantId)
      .order('nome')
    if (error) { console.warn('Produtos ausentes/erro:', error.message); setProdutos([]); return }
    setProdutos(data ?? [])
  }, [tenantId])

  const loadUsuarios = useCallback(async () => {
    if (!tenantId) return
    
    try {
      const { data, error } = await supabase
        .rpc('get_team_overview', { p_tenant_id: tenantId })
      
      if (error) {
        console.warn('Erro ao buscar membros da equipe:', error.message)
        setUsuarios([])
        return
      }
      
      if (data?.members) {
        const usuarios = data.members.map((member: { user_id: string; nome: string }) => ({
          id: member.user_id,
          display_name: member.nome
        }))
        setUsuarios(usuarios)
      } else {
        setUsuarios([])
      }
    } catch (err) {
      console.error('Erro ao carregar usu√°rios:', err)
      setUsuarios([])
    }
  }, [tenantId])

  const loadResponsaveisCustomizados = useCallback(async () => {
    if (!tenantId) return
    // Buscar todos os responsavel_nome √∫nicos que n√£o s√£o null
    const { data, error } = await supabase
      .from('tarefas')
      .select('responsavel_nome')
      .eq('tenant_id', tenantId)
      .not('responsavel_nome', 'is', null)
      .order('responsavel_nome')
    
    if (error) {
      console.warn('Erro ao carregar respons√°veis customizados:', error.message)
      setResponsaveisCustomizados([])
      return
    }
    
    // Extrair valores √∫nicos
    const unique = [...new Set(data.map(t => t.responsavel_nome).filter(Boolean))] as string[]
    setResponsaveisCustomizados(unique)
  }, [tenantId])

  const loadEquipes = useCallback(async () => {
    if (!tenantId) return
    try {
      const { data, error } = await supabase
        .from('equipes')
        .select('id, nome')
        .eq('tenant_id', tenantId)
        .order('nome')

      if (error) throw error
      setEquipes(data || [])
    } catch (error) {
      console.error('Erro ao carregar equipes:', error)
      setEquipes([])
    }
  }, [tenantId])

  // eslint-disable-next-line @typescript-eslint/no-explicit-any -- query builder do supabase tem tipos complexos; usar any aqui √© intencional
  const applyQueryFilters = (query: any, f: Filtros) => {
    if (f.q && f.q.trim()) query = query.ilike('titulo', `%${f.q}%`)
    if (f.status && f.status !== 'todos') query = query.eq('status', f.status)
    if (f.prioridade && f.prioridade !== 'todas') query = query.eq('prioridade', f.prioridade)
    if (f.clienteId && f.clienteId !== 'todos') query = query.eq('cliente_id', f.clienteId)
    if (f.produtoId && f.produtoId !== 'todos') query = query.eq('produto_id', f.produtoId)
    if (f.responsavelId && f.responsavelId !== 'todos') {
      // Verificar se √© respons√°vel customizado (prefixo "custom:")
      if (f.responsavelId.startsWith('custom:')) {
        const nome = f.responsavelId.replace('custom:', '')
        query = query.eq('responsavel_nome', nome)
      } else {
        query = query.eq('responsavel_id', f.responsavelId)
      }
    }
    if (f.dueFrom) query = query.gte('data_vencimento', f.dueFrom)
    if (f.dueTo) query = query.lte('data_vencimento', f.dueTo)
    return query
  }

  const loadTarefas = useCallback(async (f?: Filtros) => {
    if (!tenantId) return
    setLoading(true)
    try {
      let q = supabase
        .from('tarefas')
        .select(`
          id,tenant_id,titulo,descricao,status,prioridade,
          cliente_id,produto_id,responsavel_id,responsavel_nome,
          data_vencimento,process_id,tempo_gasto_minutos,
          created_at,updated_at
        `)
        .eq('tenant_id', tenantId)
        .order('created_at', { ascending: false })

      q = applyQueryFilters(q, f ?? filtros)

      const { data, error } = await q
      if (error) throw error

      setTarefas((data ?? []).map((t: Record<string, unknown>) => {
        // Parsear checklist se for string
        const checklistData = parseChecklist(t.checklist);
        
        return {
          ...t,
          checklist: checklistData,
          process_id: t.process_id || null,
          cliente: null,
          produto: null,
          responsavel: null,
          equipe: null,
          processo: null,
        };
      }) as Tarefa[])
    } catch (err) {
      console.error('Erro ao carregar tarefas:', err)
      toast.error('Erro ao carregar tarefas')
    } finally { 
      setLoading(false) 
    }
  }, [tenantId, filtros])

  useEffect(() => { loadClientes(); loadProdutos(); loadUsuarios(); loadEquipes(); loadResponsaveisCustomizados(); }, [loadClientes, loadProdutos, loadUsuarios, loadEquipes, loadResponsaveisCustomizados])
  useEffect(() => { loadTarefas() }, [loadTarefas])

  // Load task stages from Supabase on mount
  useEffect(() => {
    const loadStages = async () => {
      if (!tenant?.id) {
        return
      }
      try {
        const stages = await loadTaskStages(tenant.id)
        if (stages && stages.length > 0) {
          // Convert Supabase format to local format
          const converted = stages.map(s => ({
            id: s.id,
            key: s.key,
            label: s.label,
            color: s.color
          }))
          setTaskStages(converted)
        } else {
          // Se n√£o houver stages customizados, usar padr√£o
          setTaskStages([
            { key: 'pendente', label: 'Pendente', color: '#8B5CF6' },
            { key: 'em_andamento', label: 'Em Progresso', color: '#06B6D4' },
            { key: 'bloqueada', label: 'Bloqueada', color: '#EF4444' },
            { key: 'concluida', label: 'Conclu√≠da', color: '#10B981' }
          ])
        }
      } catch (err) {
        console.error('[ERROR] loadTaskStages:', err)
        // Em caso de erro, usar padr√£o
        setTaskStages([
          { key: 'pendente', label: 'Pendente', color: '#8B5CF6' },
          { key: 'em_andamento', label: 'Em Progresso', color: '#06B6D4' },
          { key: 'bloqueada', label: 'Bloqueada', color: '#EF4444' },
          { key: 'concluida', label: 'Conclu√≠da', color: '#10B981' }
        ])
      }
    }
    loadStages()
  }, [tenant?.id])

  // Task Stages Management
  const startEditStage = (index: number) => {
    setEditingStageIndex(index)
    setEditingStageName(taskStages[index]?.label ?? '')
  }

  const saveEditStage = async (index: number) => {
    if (!editingStageName.trim()) {
      toast.error('Nome da etapa n√£o pode ser vazio')
      return
    }
    const stage = taskStages[index]
    if (!stage) return

    const updated = taskStages.map((s, i) => i === index ? { ...s, label: editingStageName } : s)
    setTaskStages(updated)
    setEditingStageIndex(null)
    setEditingStageName('')

    // Persist to Supabase
    try {
      await updateTaskStage(stage.id!, { label: editingStageName })
      toast.success('Etapa atualizada')
    } catch (err) {
      console.error('[ERROR] updating stage:', err)
      toast.error('Erro ao atualizar etapa')
    }
  }

  const cancelEditStage = () => {
    setEditingStageIndex(null)
    setEditingStageName('')
  }

  // =====================
  // Helpers
  // =====================

  const byStatus = (s: TaskStatus) => tarefas.filter(t => t.status === s)

  const openTask = async (id: string) => {
    const t = tarefas.find(x => x.id === id)
    if (t) {
      setDetalhe(t)
      setHasUnsavedChanges(false)
    }
    setOpenTaskId(id)
  }

  const updateDetalhe = (updates: Partial<Tarefa>) => {
    if (!detalhe) return
    setDetalhe({ ...detalhe, ...updates })
    setHasUnsavedChanges(true)
  }

  const closeTask = () => {
    if (hasUnsavedChanges) {
      const confirmar = window.confirm('Voc√™ tem altera√ß√µes n√£o salvas. Deseja descartar as altera√ß√µes?')
      if (!confirmar) return
    }
    setOpenTaskId(null)
    setDetalhe(null)
    setHasUnsavedChanges(false)
    setShowCustomResponsavel(false)
  }

  const handleSaveTask = async () => {
    if (!detalhe) return
    
    try {
      const updates: Partial<Tarefa> = {
        titulo: detalhe.titulo,
        descricao: detalhe.descricao,
        status: detalhe.status,
        prioridade: detalhe.prioridade,
        cliente_id: detalhe.cliente_id,
        produto_id: detalhe.produto_id,
        responsavel_id: detalhe.responsavel_id,
        responsavel_nome: detalhe.responsavel_nome,
        data_vencimento: detalhe.data_vencimento,
        checklist: detalhe.checklist,
        tempo_gasto_minutos: detalhe.tempo_gasto_minutos,
        estimativa_minutos: detalhe.estimativa_minutos,
      }

      const { error } = await supabase
        .from('tarefas')
        .update(updates)
        .eq('id', detalhe.id)

      if (error) throw error

      toast.success('‚úÖ Tarefa salva com sucesso')
      setHasUnsavedChanges(false)
      loadTarefas(filtros)
    } catch (err) {
      console.error('Erro ao salvar tarefa:', err)
      toast.error('Erro ao salvar tarefa')
    }
  }

  const handleAddTask = () => {
    navigate('/app/tarefa-nova')
  }

  const handleUpdateTask = async (id: string, updates: Partial<Tarefa>) => {
    try {
      // Garantir que campos undefined n√£o sejam enviados
      const cleanUpdates = Object.entries(updates).reduce((acc, [key, value]) => {
        if (value !== undefined) {
          // Converter checklist e tags para JSON se forem arrays
          if (key === 'checklist' && Array.isArray(value)) {
            acc[key] = JSON.stringify(value);
          } else if (key === 'tags' && Array.isArray(value)) {
            acc[key] = value; // tags √© TEXT[], passa como est√°
          } else {
            acc[key] = value;
          }
        }
        return acc;
      }, {} as Record<string, unknown>);

      const { error } = await supabase
        .from('tarefas')
        .update(cleanUpdates)
        .eq('id', id);
        
      if (error) throw error;

      // Rebuscar tarefa atualizada
      const { data, error: fetchError } = await supabase
        .from('tarefas')
        .select(`
          id,tenant_id,titulo,descricao,status,prioridade,
          cliente_id,produto_id,responsavel_id,responsavel_nome,equipe_id,
          data_vencimento,process_id,tempo_gasto_minutos,checklist,
          created_at,updated_at
        `)
        .eq('id', id)
        .single();
        
      if (fetchError) throw fetchError;

      // Converter checklist de volta para objeto se for string
      const checklistData = parseChecklist(data.checklist);

      const atualizada: Tarefa = {
        ...data,
        process_id: ((data as Record<string, unknown>).process_id as string | null) || null,
        checklist: checklistData,
        cliente: null,
        produto: null,
        responsavel: null,
        responsavel_nome: (data as Record<string, unknown>).responsavel_nome as string ?? null,
        equipe: null,
        processo: null,
      };

      setTarefas(prev => prev.map(t => t.id === id ? atualizada : t));
      if (detalhe?.id === id) setDetalhe(atualizada);
      toast.success('Tarefa atualizada');
    } catch (err) {
      console.error('Erro ao atualizar tarefa:', err);
      toast.error('Erro ao atualizar tarefa');
    }
  };

  const handleDeleteTask = async (id: string) => {
    toast((t) => (
      <div className="flex flex-col gap-2">
        <span>Excluir esta tarefa?</span>
        <div className="flex gap-2">
          <button
            className="bg-red-500 text-white px-3 py-1 rounded text-sm"
            onClick={async () => {
              toast.dismiss(t.id)
              try {
                const { error } = await supabase.from('tarefas').delete().eq('id', id)
                if (error) throw error
                setTarefas(prev => prev.filter(t => t.id !== id))
                if (detalhe?.id === id) closeTask()
                toast.success('Tarefa exclu√≠da')
              } catch (err) {
                console.error(err)
                toast.error('Erro ao excluir tarefa')
              }
            }}
          >
            Excluir
          </button>
          <button
            className="bg-gray-500 text-white px-3 py-1 rounded text-sm"
            onClick={() => toast.dismiss(t.id)}
          >
            Cancelar
          </button>
        </div>
      </div>
    ), { duration: Infinity })
  }

  const handleDragEnd = (result: DropResult) => {
    if (!result.destination) return
    const { draggableId, destination, source } = result
    const newStatus = destination.droppableId as TaskStatus
    if (destination.droppableId !== source.droppableId) {
      handleUpdateTask(draggableId, { status: newStatus })
    }
  }

  const addChecklistItem = () => {
    if (!detalhe) return
    const next: ChecklistItem[] = [...(detalhe.checklist ?? []), { id: crypto.randomUUID(), texto: 'Novo item', done: false }]
    updateDetalhe({ checklist: next })
  }

  const toggleChecklist = (itemId: string) => {
    if (!detalhe) return
    const next = (detalhe.checklist ?? []).map(i => i.id === itemId ? { ...i, done: !i.done } : i)
    updateDetalhe({ checklist: next })
  }

  const editChecklistText = (itemId: string, texto: string) => {
    if (!detalhe) return
    const next = (detalhe.checklist ?? []).map(i => i.id === itemId ? { ...i, texto } : i)
    updateDetalhe({ checklist: next })
  }

  const removeChecklistItem = (itemId: string) => {
    if (!detalhe) return
    const next = (detalhe.checklist ?? []).filter(i => i.id !== itemId)
    updateDetalhe({ checklist: next })
  }

  const addTempoGasto = () => {
    if (!detalhe) return
    const minutos = Number(prompt('Adicionar tempo (minutos):', '30'))
    if (!Number.isFinite(minutos) || minutos <= 0) return
    const total = (detalhe.tempo_gasto_minutos ?? 0) + minutos
    updateDetalhe({ tempo_gasto_minutos: total })
  }

  // =====================
  // UI
  // =====================
  if (loading) {
    return (
      <div className="min-h-full p-6 bg-white dark:bg-[#0C1326] text-slate-900 dark:text-slate-200">
        <div className="flex flex-col items-center justify-center h-64">
          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500 mb-4"></div>
          <p className="text-slate-400">Carregando tarefas...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="text-slate-900 dark:text-slate-200 flex flex-col min-h-full relative overflow-hidden">
      {/* HUD glow grid background + overlay */}
      <div className="pointer-events-none absolute inset-0 opacity-40">
        <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 via-transparent to-purple-600/10 blur-3xl" />
        <div className="absolute inset-0 bg-[radial-gradient(circle_at_top,_rgba(14,165,233,0.15),_transparent_55%)]" />
        <div className="absolute inset-0 bg-[linear-gradient(120deg,rgba(255,255,255,0.04)_1px,transparent_1px)] bg-[length:120px_120px]" />
      </div>

      <div className="flex-1 overflow-y-auto pb-6 px-6 relative z-10">

      {/* FAB removido - bot√£o movido para o header */}

      {/* Card principal */}
      <div className="overflow-hidden">
        {/* Header com busca e filtros */}
  <div className="p-4 sm:p-6 border-b border-slate-200 dark:border-white/10">
          <div className="flex flex-col gap-4">
            {/* T√≠tulo */}
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs uppercase tracking-widest text-gray-400">Gerenciamento</div>
                <h1 className="text-xl sm:text-2xl font-semibold text-slate-900 dark:text-white">Tarefas</h1>
              </div>
              <div className="flex items-center gap-2">
                <button
                  onClick={() => setView('grid')}
                  className={`p-2 rounded-xl border border-slate-200 dark:border-white/5 bg-white dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition ${view === 'grid' ? 'ring-2 ring-emerald-500/40' : ''}`}
                  aria-label="Ver em grade"
                >
                  <Grid3X3 className="w-5 h-5 text-gray-600 dark:text-gray-200" />
                </button>
                <button
                  onClick={() => setView('kanban')}
                  className={`p-2 rounded-xl border border-slate-200 dark:border-white/5 bg-white dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition ${view === 'kanban' ? 'ring-2 ring-cyan-500/40' : ''}`}
                  aria-label="Ver em kanban"
                >
                  <Kanban className="w-5 h-5 text-gray-600 dark:text-gray-200" />
                </button>
                <button
                  onClick={() => setShowTaskStagesSettings(true)}
                  className="p-2 rounded-xl border border-slate-200 dark:border-white/5 bg-white dark:bg-white/5 hover:bg-slate-100 dark:hover:bg-white/10 transition"
                  aria-label="Configurar est√°gios"
                >
                  <Settings className="w-5 h-5 text-gray-600 dark:text-gray-200" />
                </button>
                <button onClick={handleAddTask} className="inline-flex items-center gap-2 px-3 py-3 bg-gradient-to-r from-cyan-500 to-cyan-600 text-white border border-slate-200 dark:border-white/10 hover:scale-105 active:scale-95 rounded-xl text-sm shadow-lg transition">
                  <Plus className="w-4 h-4" /> <span className="hidden sm:inline">Nova Tarefa</span>
                </button>
              </div>
            </div>

            {/* Busca e Filtros */}
            <div className="grid grid-cols-1 sm:grid-cols-5 gap-3">
              <div className="sm:col-span-4 relative">
                <Search className="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-gray-400" />
                <input
                  type="text"
                  placeholder="Buscar por t√≠tulo, descri√ß√£o, cliente..."
                  value={filtros.q ?? ''}
                  onChange={e => setFiltros(p => ({ ...p, q: e.target.value }))}
                  className="w-full pl-10 pr-3 py-2 rounded-2xl bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-900 dark:text-white placeholder:text-slate-500 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/40"
                />
              </div>
              <div className="sm:col-span-1 flex gap-2">
                <button
                  onClick={() => setFiltersOpen(true)}
                  className="flex-1 inline-flex items-center justify-center gap-2 px-3 py-2 rounded-2xl bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 hover:bg-slate-50 dark:hover:bg-white/10 transition text-sm text-slate-700 dark:text-gray-200"
                >
                  <Filter className="w-4 h-4" /> Filtros
                </button>
              </div>
            </div>
          </div>
        </div>

        {/* Conte√∫do */}
        {view === 'grid' ? (
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-slate-50 dark:bg-white/5">
                <tr className="divide-x divide-white/5">
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Tarefa</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Cliente</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Produto</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Respons√°vel</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Equipe</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Prioridade</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Status</th>
                  <th className="px-6 py-4 text-left text-xs font-semibold text-slate-700 dark:text-slate-300 uppercase tracking-wider">Entrega</th>
                  <th className="px-6 py-4" />
                </tr>
              </thead>
              <tbody className="divide-y divide-white/5">
                {tarefas.map(t => (
                  <tr key={t.id} className="hover:bg-slate-50 dark:hover:bg-white/5 transition-colors">
                    <td className="px-6 py-4">
                      <button onClick={() => openTask(t.id)} className="font-semibold text-slate-900 dark:text-white hover:text-indigo-600 dark:hover:text-indigo-300 transition-colors text-left">
                        {t.titulo}
                      </button>
                      {t.descricao && <p className="text-xs text-slate-400 mt-1 line-clamp-1">{t.descricao}</p>}
                    </td>
                    <td className="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">{t.cliente?.nome ?? '-'}</td>
                    <td className="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">{t.produto?.nome ?? '-'}</td>
                    <td className="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">{t.responsavel?.display_name ?? t.responsavel_nome ?? '-'}</td>
                    <td className="px-6 py-4">
                      <span className={`px-2 py-1 rounded-lg text-xs font-medium ${PRIORITY_MAP[t.prioridade].pill}`}>{PRIORITY_MAP[t.prioridade].label}</span>
                    </td>
                    <td className="px-6 py-4">
                      <select value={t.status ?? 'pendente'} onChange={e => handleUpdateTask(t.id, { status: e.target.value as TaskStatus })} className={`px-3 py-2 rounded-xl text-xs font-semibold border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 ${STATUS_MAP[t.status as TaskStatus]?.ring || 'ring-indigo-500/30'} [&>option]:bg-white dark:[&>option]:bg-slate-800 [&>option]:text-slate-900 dark:[&>option]:text-white`}>
                        <option value="pendente" className="bg-slate-800 text-white">Pendente</option>
                        <option value="em_andamento" className="bg-slate-800 text-white">Em Progresso</option>
                        <option value="bloqueada" className="bg-slate-800 text-white">Bloqueada</option>
                        <option value="concluida" className="bg-slate-800 text-white">Conclu√≠da</option>
                      </select>
                    </td>
                    <td className="px-6 py-4 text-sm text-slate-700 dark:text-slate-300">{t.data_vencimento ? new Date(t.data_vencimento).toLocaleDateString('pt-BR') : '-'}</td>
                    <td className="px-6 py-4 text-right">
                      <button onClick={() => handleDeleteTask(t.id)} className="w-8 h-8 bg-rose-500/10 hover:bg-rose-500/20 text-rose-600 dark:text-rose-200 rounded-lg inline-flex items-center justify-center transition" title="Excluir"><Trash2 className="w-4 h-4"/></button>
                    </td>
                  </tr>
                ))}
                {tarefas.length === 0 && (
                  <tr><td colSpan={8} className="px-6 py-10 text-center text-slate-400">Nenhuma tarefa.</td></tr>
                )}
              </tbody>
            </table>
          </div>
        ) : (
          <DragDropContext onDragEnd={handleDragEnd}>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 p-6">
              {taskStages.map(stage => (
                <Droppable key={stage.key} droppableId={stage.key}>
                  {(provided, snapshot) => (
                    <div ref={provided.innerRef} {...provided.droppableProps} className={`rounded-3xl border p-4 min-h-[420px] transition-colors bg-white/5 border-white/10 ${snapshot.isDraggingOver ? 'ring-2 ring-cyan-500/30' : ''}`}>
                      <div className="flex items-center mb-4">
                        <div className="text-sm font-bold text-slate-900 dark:text-white flex flex-col gap-1 flex-1">
                          <div className="flex items-center gap-2">
                            <span className={`w-3 h-3 rounded-full`} style={{ background: stage.color }} />
                            {stage.label}
                            <span className="text-[12px] font-semibold text-slate-500 dark:text-gray-400 bg-slate-200 dark:bg-white/10 px-2 py-0.5 rounded-lg">({byStatus(stage.key).length})</span>
                          </div>
                          <div className="flex items-center gap-2">
                            <span className="text-[10px] text-slate-400 dark:text-slate-500 font-mono bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">
                              ID: {stage.id || stage.key}
                            </span>
                            <span className="text-[10px] text-slate-400 dark:text-slate-500 font-mono bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded">
                              Key: {stage.key}
                            </span>
                          </div>
                        </div>
                      </div>
                      <div className="space-y-3">
                        {byStatus(stage.key).map((t, idx) => (
                          <Draggable key={t.id} draggableId={t.id} index={idx}>
                            {(prov, snap) => (
                              <div ref={prov.innerRef} {...prov.draggableProps} {...prov.dragHandleProps} onClick={() => openTask(t.id)} className={`bg-white dark:bg-white/5 rounded-2xl p-4 cursor-move hover:bg-slate-50 dark:hover:bg-white/10 transition-all border border-slate-200 dark:border-white/10 ${snap.isDragging ? 'shadow-2xl scale-[1.02]' : 'shadow-sm'}`}>
                                <div className="flex items-start justify-between gap-3">
                                  <div>
                                    <h4 className="font-medium text-slate-900 dark:text-slate-100 text-sm">{t.titulo}</h4>
                                    {t.descricao && <p className="text-xs text-slate-600 dark:text-slate-400 mt-1 line-clamp-2">{t.descricao}</p>}
                                  </div>
                                  <span className={`px-2 py-1 rounded-lg text-[10px] font-medium ${PRIORITY_MAP[t.prioridade].pill}`}>{PRIORITY_MAP[t.prioridade].label}</span>
                                </div>
                                <div className="mt-3 flex flex-wrap items-center gap-3 text-xs text-slate-600 dark:text-slate-400">
                                  {t.cliente?.nome && <span className="inline-flex items-center gap-1"><Users className="w-3 h-3"/>{t.cliente.nome}</span>}
                                  {t.produto?.nome && <span className="inline-flex items-center gap-1"><Tag className="w-3 h-3"/>{t.produto.nome}</span>}
                                  {t.equipe_id && <span className="inline-flex items-center gap-1"><Users className="w-3 h-3 text-cyan-400"/>Equipe {t.equipe_id.slice(0, 8)}...</span>}
                                  {t.data_vencimento && <span className="inline-flex items-center gap-1"><CalendarDays className="w-3 h-3"/>{new Date(t.data_vencimento).toLocaleDateString('pt-BR')}</span>}
                                  {typeof t.tempo_gasto_minutos === 'number' && t.tempo_gasto_minutos>0 && (
                                    <span className="inline-flex items-center gap-1"><Timer className="w-3 h-3"/>{t.tempo_gasto_minutos}m</span>
                                  )}
                                </div>
                              </div>
                            )}
                          </Draggable>
                        ))}
                        {provided.placeholder}
                      </div>
                    </div>
                  )}
                </Droppable>
              ))}
            </div>
          </DragDropContext>
        )}
      </div>

      {/* Popup de Filtros Avan√ßados */}
      {filtersOpen && (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={() => setFiltersOpen(false)} />
          <div className="absolute w-full max-w-4xl max-h-[90vh] rounded-3xl bg-white dark:bg-slate-900/95 border border-slate-200 dark:border-white/10 shadow-2xl overflow-y-auto">
            <div className="p-6">
              <div className="flex items-center justify-between mb-6">
                <div className="text-lg font-semibold text-slate-900 dark:text-white flex items-center gap-3">
                  <Filter className="w-5 h-5 text-cyan-400" />
                  Filtros Avan√ßados de Tarefas
                </div>
                <button onClick={() => setFiltersOpen(false)} className="p-2 rounded-xl hover:bg-slate-100 dark:hover:bg-white/5 transition">
                  <X className="w-5 h-5 text-slate-600 dark:text-gray-300" />
                </button>
              </div>
              
              <div className="space-y-6">
                {/* Status e Prioridade */}
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  {/* Status */}
                  <div className="bg-slate-50 dark:bg-white/5 rounded-2xl p-5 border border-slate-200 dark:border-white/10">
                    <label className="text-sm font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-cyan-400" />
                      Status da Tarefa
                    </label>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {[{key: 'todos', label: 'üìã Todos os Status'}, {key: 'a_fazer', label: 'üìù A Fazer'}, {key: 'em_andamento', label: 'üöÄ Em Progresso'}, {key: 'bloqueada', label: 'üö´ Bloqueada'}, {key: 'concluida', label: '‚úÖ Conclu√≠da'}].map((s) => (
                        <button
                          key={s.key}
                          onClick={() => setFiltros(p => ({ ...p, status: s.key as TaskStatus | 'todos' }))}
                          className={`px-4 py-3 rounded-xl border text-sm font-medium transition transform hover:scale-[1.02] ${filtros.status === s.key
                            ? 'bg-gradient-to-r from-cyan-500/20 to-cyan-600/20 border-cyan-500/40 text-slate-900 dark:text-white ring-2 ring-cyan-500/30 shadow-lg' 
                            : 'bg-white dark:bg-white/5 border-slate-300 dark:border-white/10 text-slate-700 dark:text-gray-300 hover:bg-slate-100 dark:hover:bg-white/10 hover:border-slate-400 dark:hover:border-white/20'
                          }`}
                        >
                          {s.label}
                        </button>
                      ))}
                    </div>
                  </div>

                  {/* Prioridade */}
                  <div className="bg-slate-50 dark:bg-white/5 rounded-2xl p-5 border border-slate-200 dark:border-white/10">
                    <label className="text-sm font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                      <div className="w-2 h-2 rounded-full bg-amber-400" />
                      Prioridade
                    </label>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                      {[{key: 'todas', label: 'üéØ Todas'}, {key: 'baixa', label: 'üü¢ Baixa'}, {key: 'media', label: 'üü° M√©dia'}, {key: 'alta', label: 'üü† Alta'}, {key: 'urgente', label: 'üî¥ Urgente'}].map((p) => (
                        <button
                          key={p.key}
                          onClick={() => setFiltros(f => ({ ...f, prioridade: p.key as TaskPriority | 'todas' }))}
                          className={`px-4 py-3 rounded-xl border text-sm font-medium transition transform hover:scale-[1.02] ${filtros.prioridade === p.key
                            ? 'bg-gradient-to-r from-amber-500/20 to-amber-600/20 border-amber-500/40 text-slate-900 dark:text-white ring-2 ring-amber-500/30 shadow-lg' 
                            : 'bg-white dark:bg-white/5 border-slate-300 dark:border-white/10 text-slate-700 dark:text-gray-300 hover:bg-slate-100 dark:hover:bg-white/10 hover:border-slate-400 dark:hover:border-white/20'
                          }`}
                        >
                          {p.label}
                        </button>
                      ))}
                    </div>
                  </div>
                </div>

                {/* Atribui√ß√µes */}
                <div className="bg-slate-50 dark:bg-white/5 rounded-2xl p-5 border border-slate-200 dark:border-white/10">
                  <label className="text-sm font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                    <div className="w-2 h-2 rounded-full bg-emerald-400" />
                    Atribui√ß√µes e Relacionamentos
                  </label>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div>
                      <label className="text-xs text-slate-700 dark:text-gray-400 mb-2 block font-medium">Cliente</label>
                      <select 
                        value={filtros.clienteId ?? 'todos'} 
                        onChange={e => setFiltros(p => ({ ...p, clienteId: e.target.value as string | 'todos' }))} 
                        className="w-full px-3 py-2 border border-slate-300 dark:border-white/10 rounded-xl bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition text-sm [&>option]:bg-slate-100 dark:[&>option]:bg-slate-800 [&>option]:text-slate-900 dark:[&>option]:text-white dark:dark-select"
                      >
                        <option value="todos" className="bg-slate-100 text-slate-900">Todos clientes</option>
                        {clientes.map(c => <option key={c.id} value={c.id} className="bg-slate-100 text-slate-900">{c.nome}</option>)}
                      </select>
                    </div>

                    <div>
                      <label className="text-xs text-slate-700 dark:text-gray-400 mb-2 block font-medium">Produto</label>
                      <select 
                        value={filtros.produtoId ?? 'todos'} 
                        onChange={e => setFiltros(p => ({ ...p, produtoId: e.target.value as string | 'todos' }))} 
                        className="w-full px-3 py-2 border border-slate-300 dark:border-white/10 rounded-xl bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition text-sm [&>option]:bg-slate-100 dark:[&>option]:bg-slate-800 [&>option]:text-slate-900 dark:[&>option]:text-white dark:dark-select"
                      >
                        <option value="todos" className="bg-slate-100 text-slate-900">Todos produtos</option>
                        {produtos.map(p => <option key={p.id} value={p.id} className="bg-slate-100 text-slate-900">{p.nome}</option>)}
                      </select>
                    </div>

                    <div>
                      <label className="text-xs text-slate-700 dark:text-gray-400 mb-2 block font-medium">Respons√°vel</label>
                      <select 
                        value={filtros.responsavelId ?? 'todos'} 
                        onChange={e => setFiltros(p => ({ ...p, responsavelId: e.target.value as string | 'todos' }))} 
                        className="w-full px-3 py-2 border border-slate-300 dark:border-white/10 rounded-xl bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition text-sm [&>option]:bg-slate-100 dark:[&>option]:bg-slate-800 [&>option]:text-slate-900 dark:[&>option]:text-white dark:dark-select"
                      >
                        <option value="todos" className="bg-slate-100 text-slate-900">Todos respons√°veis</option>
                        {usuarios.map(u => <option key={u.id} value={u.id} className="bg-slate-100 text-slate-900">{u.display_name ?? u.id}</option>)}
                        {responsaveisCustomizados.length > 0 && <option disabled className="bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-400">‚îÄ‚îÄ‚îÄ Outros ‚îÄ‚îÄ‚îÄ</option>}
                        {responsaveisCustomizados.map(nome => <option key={`custom-${nome}`} value={`custom:${nome}`} className="bg-slate-100 text-slate-900">{nome}</option>)}
                      </select>
                    </div>

                    <div>
                      <label className="text-xs text-slate-700 dark:text-gray-400 mb-2 block font-medium">Equipe</label>
                      <select 
                        value={filtros.equipeId ?? 'todas'} 
                        onChange={e => setFiltros(p => ({ ...p, equipeId: e.target.value as string | 'todas' }))} 
                        className="w-full px-3 py-2 border border-slate-300 dark:border-white/10 rounded-xl bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-emerald-500/30 transition text-sm [&>option]:bg-slate-100 dark:[&>option]:bg-slate-800 [&>option]:text-slate-900 dark:[&>option]:text-white dark:dark-select"
                      >
                        <option value="todas" className="bg-slate-100 text-slate-900">Todas equipes</option>
                        {equipes.map(eq => <option key={eq.id} value={eq.id} className="bg-slate-100 text-slate-900">{eq.nome}</option>)}
                      </select>
                    </div>
                  </div>
                </div>

                {/* Datas */}
                <div className="bg-slate-50 dark:bg-white/5 rounded-2xl p-5 border border-slate-200 dark:border-white/10">
                  <label className="text-sm font-semibold text-slate-900 dark:text-white mb-4 flex items-center gap-2">
                    <div className="w-2 h-2 rounded-full bg-purple-400" />
                    Per√≠odo de Vencimento
                  </label>
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    <div>
                      <label className="text-xs text-slate-700 dark:text-gray-400 mb-2 block font-medium">Data inicial</label>
                      <input 
                        type="date" 
                        onChange={e => setFiltros(p => ({ ...p, dueFrom: e.target.value }))} 
                        className="w-full px-4 py-3 border border-slate-300 dark:border-white/10 rounded-xl bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500/30 transition" 
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-700 dark:text-gray-400 mb-2 block font-medium">Data final</label>
                      <input 
                        type="date" 
                        onChange={e => setFiltros(p => ({ ...p, dueTo: e.target.value }))} 
                        className="w-full px-4 py-3 border border-slate-300 dark:border-white/10 rounded-xl bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500/30 transition" 
                      />
                    </div>
                  </div>
                </div>

                {/* Bot√µes de a√ß√£o */}
                <div className="flex gap-4 pt-2">
                  <button
                    onClick={() => setFiltros({ status: 'todos', prioridade: 'todas', clienteId: 'todos', produtoId: 'todos', responsavelId: 'todos', equipeId: 'todas' })}
                    className="flex-1 px-6 py-3 rounded-xl border border-slate-300 dark:border-white/10 bg-white dark:bg-white/5 hover:bg-slate-50 dark:hover:bg-white/10 text-slate-900 dark:text-gray-200 font-medium transition transform hover:scale-[1.02] flex items-center justify-center gap-2"
                  >
                    <X className="w-4 h-4" />
                    Limpar Filtros
                  </button>
                  <button
                    onClick={() => {
                      loadTarefas(filtros)
                      setFiltersOpen(false)
                    }}
                    className="flex-1 px-6 py-3 rounded-xl bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white border border-white/10 font-medium hover:scale-105 active:scale-95 transition transform flex items-center justify-center gap-2 shadow-lg hover:shadow-cyan-500/30"
                  >
                    <Filter className="w-4 h-4" />
                    Aplicar Filtros
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Drawer Detalhe da Tarefa */}
  <div className={`fixed inset-4 sm:top-4 sm:bottom-4 sm:right-4 sm:left-auto w-[calc(100vw-2rem)] sm:w-[520px] bg-slate-100 dark:bg-black/40 backdrop-blur-md shadow-2xl transform transition-all duration-300 ease-in-out border border-slate-300 dark:border-white/10 rounded-3xl ${openTaskId ? 'translate-x-0' : 'translate-x-[calc(100vw+4rem)] sm:translate-x-[600px]'} z-50`}>
        <div className="h-full flex flex-col">
          {/* Bot√£o de fechar no topo */}
          <div className="flex justify-end p-3 sm:p-4 pt-4 sm:pt-6">
            <button onClick={closeTask} className="w-8 h-8 bg-white/10 dark:bg-white/10 hover:bg-slate-300 dark:hover:bg-white/20 rounded-full flex items-center justify-center transition-colors text-slate-700 dark:text-white/80 hover:text-slate-900 dark:hover:text-white">
              <X className="w-5 h-5"/>
            </button>
          </div>

          {/* Header */}
          <div className="flex items-center justify-between px-3 sm:px-4 pb-3 border-b border-slate-300 dark:border-white/10">
            <div className="flex items-center gap-2">
              <FileText className="w-5 h-5 text-indigo-600 dark:text-indigo-300" />
              <h3 className="text-base sm:text-lg font-semibold text-slate-900 dark:text-slate-200">Detalhes da Tarefa</h3>
            </div>
            {detalhe && (
              <button
                onClick={handleSaveTask}
                disabled={!hasUnsavedChanges}
                className={`inline-flex items-center gap-2 px-4 py-2 rounded-xl text-sm font-medium transition-all shadow-lg ${
                  hasUnsavedChanges
                    ? 'bg-gradient-to-r from-emerald-600 to-emerald-500 text-white hover:from-emerald-700 hover:to-emerald-600 hover:shadow-emerald-500/20'
                    : 'bg-slate-200 dark:bg-white/5 text-slate-400 cursor-not-allowed'
                }`}
              >
                <Check className="w-4 h-4" />
                {hasUnsavedChanges ? 'Salvar' : 'Salvo'}
              </button>
            )}
          </div>

          {/* Body */}
          <div className="flex-1 overflow-y-auto px-3 sm:px-4 pb-3 sm:pb-4 pt-1 sm:pt-2 space-y-3 sm:space-y-4">
            {!detalhe ? (
              <p className="text-slate-600 dark:text-slate-400">Selecione uma tarefa para ver os detalhes.</p>
            ) : (
              <>
                {/* T√≠tulo */}
                <div>
                  <label className="text-xs text-slate-600 dark:text-slate-400">T√≠tulo</label>
                  <input value={detalhe.titulo} onChange={e => updateDetalhe({ titulo: e.target.value })} className="mt-1 w-full border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30" />
                </div>

                {/* Descri√ß√£o */}
                <div>
                  <label className="text-xs text-slate-600 dark:text-slate-400">Descri√ß√£o</label>
                  <textarea value={detalhe.descricao ?? ''} onChange={e => updateDetalhe({ descricao: e.target.value })} className="mt-1 w-full min-h-[100px] border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 placeholder-slate-400 dark:placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"/>
                </div>

                {/* Linha de campos */}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div>
                    <label className="text-xs text-slate-600 dark:text-slate-400">Status</label>
                    <select value={detalhe.status ?? 'pendente'} onChange={e => updateDetalhe({ status: e.target.value as TaskStatus })} className={`mt-1 w-full border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 ${STATUS_MAP[detalhe.status as TaskStatus]?.ring || 'ring-indigo-500/30'} [&>option]:bg-slate-800 [&>option]:text-white`}>
                      <option value="pendente" className="bg-slate-800 text-white">Pendente</option>
                      <option value="em_andamento" className="bg-slate-800 text-white">Em Progresso</option>
                      <option value="bloqueada" className="bg-slate-800 text-white">Bloqueada</option>
                      <option value="concluida" className="bg-slate-800 text-white">Conclu√≠da</option>
                    </select>
                  </div>
                  <div>
                    <label className="text-xs text-slate-600 dark:text-slate-400">Prioridade</label>
                    <select value={detalhe.prioridade} onChange={e => updateDetalhe({ prioridade: e.target.value as TaskPriority })} className="mt-1 w-full border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 [&>option]:bg-slate-800 [&>option]:text-white">
                      <option value="baixa" className="bg-slate-800 text-white">Baixa</option>
                      <option value="media" className="bg-slate-800 text-white">M√©dia</option>
                      <option value="alta" className="bg-slate-800 text-white">Alta</option>
                      <option value="urgente" className="bg-slate-800 text-white">Urgente</option>
                    </select>
                  </div>
                  <div>
                    <label className="text-xs text-slate-600 dark:text-slate-400">Cliente</label>
                    <select value={detalhe.cliente_id ?? ''} onChange={e => { const id = e.target.value || null; const obj = clientes.find(c => c.id === id) || null; updateDetalhe({ cliente_id: id, cliente: obj }) }} className="mt-1 w-full border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 [&>option]:bg-slate-800 [&>option]:text-white">
                      <option value="" className="bg-slate-800 text-white">Sem cliente</option>
                      {clientes.map(c => <option key={c.id} value={c.id} className="bg-slate-800 text-white">{c.nome}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="text-xs text-slate-600 dark:text-slate-400">Produto</label>
                    <select value={detalhe.produto_id ?? ''} onChange={e => { const id = e.target.value || null; const obj = produtos.find(p => p.id === id) || null; updateDetalhe({ produto_id: id, produto: obj }) }} className="mt-1 w-full border border-slate-300 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 [&>option]:bg-slate-800 [&>option]:text-white">
                      <option value="" className="bg-slate-800 text-white">Sem produto</option>
                      {produtos.map(p => <option key={p.id} value={p.id} className="bg-slate-800 text-white">{p.nome}</option>)}
                    </select>
                  </div>
                  <div>
                    <label className="text-xs text-slate-600 dark:text-slate-400">Respons√°vel</label>
                    <select
                      value={detalhe.responsavel_id ?? ''}
                      onChange={e => {
                        const v = e.target.value || null;
                        const obj = usuarios.find(u => u.id === v) || null;
                        updateDetalhe({ responsavel_id: v, responsavel: obj, responsavel_nome: null });
                        setShowCustomResponsavel(false);
                      }}
                      className="mt-1 w-full border border-slate-200 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30 [&>option]:bg-slate-800 [&>option]:text-white"
                    >
                      <option value="" className="bg-slate-800 text-white">Sem respons√°vel</option>
                      {usuarios.map(u => <option key={u.id} value={u.id} className="bg-slate-800 text-white">{u.display_name ?? u.id}</option>)}
                    </select>

                    {/* Bot√£o para adicionar nome customizado */}
                    {!showCustomResponsavel && !detalhe.responsavel_nome && (
                      <button
                        onClick={() => {
                          setShowCustomResponsavel(true);
                          setDetalhe({ ...detalhe, responsavel_id: null, responsavel: null, responsavel_nome: '' });
                        }}
                        className="mt-2 text-xs text-cyan-400 hover:text-cyan-300 transition-colors flex items-center gap-1"
                      >
                        <Plus className="w-3 h-3" />
                        Adicionar outro respons√°vel
                      </button>
                    )}

                    {/* Campo livre para nome personalizado - modo edi√ß√£o */}
                    {showCustomResponsavel && (
                      <div className="mt-2 space-y-2">
                        <input
                          value={detalhe.responsavel_nome ?? ''}
                          onChange={e => setDetalhe({ ...detalhe, responsavel_nome: e.target.value, responsavel_id: null, responsavel: null })}
                          placeholder="Nome do respons√°vel"
                          className="w-full border border-slate-200 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"
                          autoFocus
                        />
                        <div className="flex items-center gap-2">
                          <button
                            onClick={async () => {
                              if (!detalhe.responsavel_nome?.trim()) {
                                toast.error('Digite um nome para o respons√°vel');
                                return;
                              }
                              
                              // Registrar respons√°vel no sistema (apenas valida√ß√£o)
                              const result = await addResponsavel(tenantId, detalhe.responsavel_nome);
                              
                              if (result.success) {
                                // Marcar como mudan√ßa n√£o salva
                                updateDetalhe({
                                  responsavel_id: null,
                                  responsavel_nome: detalhe.responsavel_nome.trim()
                                });
                                setShowCustomResponsavel(false);
                                
                                // Recarregar lista de respons√°veis customizados
                                loadResponsaveisCustomizados();
                              }
                            }}
                            className="flex-1 inline-flex items-center justify-center gap-2 px-4 py-2 rounded-xl bg-gradient-to-r from-cyan-600 to-cyan-500 text-white text-sm font-medium hover:from-cyan-700 hover:to-cyan-600 transition-all shadow-lg hover:shadow-cyan-500/20"
                          >
                            <Check className="w-4 h-4" />
                            Salvar
                          </button>
                          <button
                            onClick={() => {
                              setShowCustomResponsavel(false);
                              updateDetalhe({ responsavel_nome: null });
                            }}
                            className="px-4 py-2 rounded-xl border border-slate-200 dark:border-white/10 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-300 text-sm hover:bg-slate-50 dark:hover:bg-white/10 transition-colors"
                            title="Cancelar"
                          >
                            <X className="w-4 h-4" />
                          </button>
                        </div>
                      </div>
                    )}

                    {/* Exibir respons√°vel customizado salvo */}
                    {!showCustomResponsavel && detalhe.responsavel_nome && (
                      <div className="mt-2 flex items-center justify-between bg-cyan-500/10 border border-cyan-500/30 rounded-xl px-3 py-2">
                        <span className="text-sm text-cyan-200">{detalhe.responsavel_nome}</span>
                        <button
                          onClick={() => {
                            setShowCustomResponsavel(true);
                          }}
                          className="text-cyan-400 hover:text-cyan-300 transition-colors text-xs"
                        >
                          Editar
                        </button>
                      </div>
                    )}
                  </div>
                  <div>
                    <label className="text-xs text-slate-400">Entrega</label>
                    <input type="date" value={detalhe.data_vencimento ? detalhe.data_vencimento.substring(0,10) : ''} onChange={e => updateDetalhe({ data_vencimento: e.target.value || null })} className="mt-1 w-full border border-slate-200 dark:border-white/10 rounded-xl px-3 py-2 bg-white dark:bg-white/5 text-slate-900 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500/30"/>
                  </div>
                </div>

                {/* Checklist */}
                <div className="border border-slate-200 dark:border-white/10 rounded-xl">
                  <button onClick={()=>setShowChecklist(s=>!s)} className="w-full px-4 py-3 flex items-center justify-between text-slate-900 dark:text-slate-200 hover:bg-slate-50 dark:hover:bg-white/5">
                    <span className="inline-flex items-center gap-2"><ListChecks className="w-4 h-4"/>Checklist</span>
                    {showChecklist ? <ChevronUp className="w-4 h-4"/> : <ChevronDown className="w-4 h-4"/>}
                  </button>
                  {showChecklist && (
                    <div className="p-4 space-y-2 bg-white dark:bg-white/5">
                      {(detalhe.checklist ?? []).map(item => (
                        <div key={item.id} className="flex items-center gap-2">
                          <button onClick={() => toggleChecklist(item.id)} className={`w-5 h-5 rounded-md border border-slate-200 dark:border-white/10 flex items-center justify-center ${item.done ? 'bg-emerald-500/20 text-emerald-200' : 'bg-white dark:bg-white/5 text-slate-400'}`}>
                            <Check className="w-3 h-3"/>
                          </button>
                          <input value={item.texto} onChange={e => editChecklistText(item.id, e.target.value)} className="flex-1 px-2 py-1 rounded-lg bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-900 dark:text-slate-200 focus:outline-none"/>
                          <button onClick={() => removeChecklistItem(item.id)} className="w-8 h-8 bg-rose-500/10 hover:bg-rose-500/20 text-rose-200 rounded-lg inline-flex items-center justify-center transition" title="Remover"><X className="w-4 h-4"/></button>
                        </div>
                      ))}
                      <button onClick={addChecklistItem} className="mt-2 text-xs px-3 py-2 rounded-lg bg-gradient-to-r from-cyan-500 to-cyan-600 text-white hover:scale-105 active:scale-95 transition">+ Item</button>
                    </div>
                  )}
                </div>

                {/* Anexos */}
                <div className="border border-slate-200 dark:border-white/10 rounded-xl">
                  <TaskAttachments tarefaId={detalhe.id} />
                </div>

                {/* Tempo */}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                  <div className="bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl p-3">
                    <div className="text-xs text-slate-400">Estimativa</div>
                    <div className="mt-1 flex items-center gap-2">
                      <AlarmClock className="w-4 h-4 text-indigo-300"/>
                      <input type="number" min={0} value={detalhe.estimativa_minutos ?? 0} onChange={e => updateDetalhe({ estimativa_minutos: Number(e.target.value) })} className="w-24 px-2 py-1 rounded-lg bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 text-slate-900 dark:text-slate-200"/> <span className="text-xs text-slate-400">min</span>
                    </div>
                  </div>
                  <div className="bg-white dark:bg-white/5 border border-slate-200 dark:border-white/10 rounded-xl p-3">
                    <div className="text-xs text-slate-400">Tempo gasto</div>
                    <div className="mt-1 flex items-center gap-2">
                      <Timer className="w-4 h-4 text-emerald-300"/>
                      <div className="text-slate-900 dark:text-slate-200 text-sm">{detalhe.tempo_gasto_minutos ?? 0} min</div>
                      <button onClick={addTempoGasto} className="ml-auto px-2 py-1 text-xs bg-emerald-600 text-emerald-100 rounded-lg hover:bg-emerald-500">+ Adicionar</button>
                    </div>
                  </div>
                </div>

                {/* A√ß√µes r√°pidas */}
                <div className="flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                  <button onClick={() => handleDeleteTask(detalhe.id)} className="w-full sm:w-auto px-3 py-2 bg-rose-500/10 hover:bg-rose-500/20 text-rose-200 rounded-lg inline-flex items-center justify-center gap-2"><Trash2 className="w-4 h-4"/>Excluir</button>
                </div>
              </>
            )}
          </div>
        </div>
      </div>

      </div>
    </div>
  )
}
            { / *   M o d a l   d e   C o n f i g u r a Á „ o   d o s   S t a g e s   * / }  
 